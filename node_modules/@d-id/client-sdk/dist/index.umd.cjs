(function(f,I){typeof exports=="object"&&typeof module<"u"?I(exports):typeof define=="function"&&define.amd?define(["exports"],I):(f=typeof globalThis<"u"?globalThis:f||self,I(f.index={}))})(this,function(f){"use strict";var jt=Object.defineProperty;var bt=(f,I,H)=>I in f?jt(f,I,{enumerable:!0,configurable:!0,writable:!0,value:H}):f[I]=H;var ne=(f,I,H)=>bt(f,typeof I!="symbol"?I+"":I,H);class I extends Error{constructor({kind:a,description:r,error:s}){super(JSON.stringify({kind:a,description:r}));ne(this,"kind");ne(this,"description");ne(this,"error");this.kind=a,this.description=r,this.error=s}}class H extends I{constructor(t,a){super({kind:"ChatCreationFailed",description:`Failed to create ${a?"persistent":""} chat, mode: ${t}`})}}class de extends I{constructor(t){super({kind:"ChatModeDowngraded",description:`Chat mode downgraded to ${t}`})}}class V extends I{constructor(a,r){super({kind:"ValidationError",description:a});ne(this,"key");this.key=r}}class le extends I{constructor(t){super({kind:"WSError",description:t})}}var ue=(e=>(e.TRIAL="trial",e.BASIC="basic",e.ENTERPRISE="enterprise",e.LITE="lite",e.ADVANCED="advanced",e))(ue||{}),fe=(e=>(e.TRIAL="deid-trial",e.PRO="deid-pro",e.ENTERPRISE="deid-enterprise",e.LITE="deid-lite",e.ADVANCED="deid-advanced",e.BUILD="deid-api-build",e.LAUNCH="deid-api-launch",e.SCALE="deid-api-scale",e))(fe||{}),me=(e=>(e.Created="created",e.Started="started",e.Done="done",e.Error="error",e.Rejected="rejected",e.Ready="ready",e))(me||{}),ge=(e=>(e.Unrated="Unrated",e.Positive="Positive",e.Negative="Negative",e))(ge||{}),R=(e=>(e.Functional="Functional",e.TextOnly="TextOnly",e.Maintenance="Maintenance",e.Playground="Playground",e.DirectPlayback="DirectPlayback",e.Off="Off",e))(R||{}),q=(e=>(e.Embed="embed",e.Query="query",e.Partial="partial",e.Answer="answer",e.Complete="done",e))(q||{}),he=(e=>(e.KnowledgeProcessing="knowledge/processing",e.KnowledgeIndexing="knowledge/indexing",e.KnowledgeFailed="knowledge/error",e.KnowledgeDone="knowledge/done",e))(he||{}),we=(e=>(e.Knowledge="knowledge",e.Document="document",e.Record="record",e))(we||{}),pe=(e=>(e.Pdf="pdf",e.Text="text",e.Html="html",e.Word="word",e.Json="json",e.Markdown="markdown",e.Csv="csv",e.Excel="excel",e.Powerpoint="powerpoint",e.Archive="archive",e.Image="image",e.Audio="audio",e.Video="video",e))(pe||{}),ae=(e=>(e.Clip="clip",e.Talk="talk",e.Expressive="expressive",e))(ae||{});const Le=e=>{switch(e){case"clip":return"clip";case"talk":return"talk";default:throw new Error(`Unknown video type: ${e}`)}};var w=(e=>(e.Start="START",e.Stop="STOP",e))(w||{}),Y=(e=>(e.Strong="STRONG",e.Weak="WEAK",e.Unknown="UNKNOWN",e))(Y||{}),O=(e=>(e.Idle="IDLE",e.Talking="TALKING",e))(O||{}),b=(e=>(e.ChatAnswer="chat/answer",e.ChatPartial="chat/partial",e.StreamDone="stream/done",e.StreamStarted="stream/started",e.StreamFailed="stream/error",e.StreamReady="stream/ready",e.StreamCreated="stream/created",e.StreamInterrupt="stream/interrupt",e.StreamVideoCreated="stream-video/started",e.StreamVideoDone="stream-video/done",e.StreamVideoError="stream-video/error",e.StreamVideoRejected="stream-video/rejected",e))(b||{}),D=(e=>(e.New="new",e.Fail="fail",e.Connected="connected",e.Connecting="connecting",e.Closed="closed",e.Completed="completed",e.Disconnected="disconnected",e))(D||{}),N=(e=>(e.Legacy="legacy",e.Fluent="fluent",e))(N||{}),ye=(e=>(e.Livekit="livekit",e))(ye||{}),ve=(e=>(e.Amazon="amazon",e.Microsoft="microsoft",e.Afflorithmics="afflorithmics",e.Elevenlabs="elevenlabs",e))(ve||{}),ke=(e=>(e.Public="public",e.Premium="premium",e.Private="private",e))(ke||{});const Be=45*1e3,$e="X-Playground-Chat",Z="https://api.d-id.com",ze="wss://notifications.d-id.com",Fe="79f81a83a67430be2bc0fd61042b8faa",Ce=e=>new Promise(t=>setTimeout(t,e)),Q=(e=16)=>{const t=new Uint8Array(e);return window.crypto.getRandomValues(t),Array.from(t,a=>a.toString(16).padStart(2,"0")).join("").slice(0,13)},Ne=e=>[R.TextOnly,R.Playground,R.Maintenance].includes(e),De=e=>e&&[R.DirectPlayback,R.Off].includes(e);function Je(e,t){let a;return{promise:new Promise((s,o)=>{a=setTimeout(()=>o(new Error(t)),e)}),clear:()=>clearTimeout(a)}}async function ie(e,t){const a={limit:(t==null?void 0:t.limit)??3,delayMs:(t==null?void 0:t.delayMs)??0,timeout:(t==null?void 0:t.timeout)??3e4,timeoutErrorMessage:(t==null?void 0:t.timeoutErrorMessage)||"Timeout error",shouldRetryFn:(t==null?void 0:t.shouldRetryFn)??(()=>!0),onRetry:(t==null?void 0:t.onRetry)??(()=>{})};let r;for(let s=1;s<=a.limit;s++)try{if(!a.timeout)return await e();const{promise:o,clear:c}=Je(a.timeout,a.timeoutErrorMessage),n=e().finally(c);return await Promise.race([n,o])}catch(o){if(r=o,!a.shouldRetryFn(o)||s>=a.limit)throw o;await Ce(a.delayMs),a.onRetry(o)}throw r}function Se(){let e=window.localStorage.getItem("did_external_key_id");if(!e){let t=Q();window.localStorage.setItem("did_external_key_id",t),e=t}return e}let We=Q();function Re(e){if(e.type==="bearer")return`Bearer ${e.token}`;if(e.type==="basic")return`Basic ${btoa(`${e.username}:${e.password}`)}`;if(e.type==="key")return`Client-Key ${e.clientKey}.${Se()}_${We}`;throw new Error(`Unknown auth type: ${e}`)}const Ue=e=>ie(e,{limit:3,delayMs:1e3,timeout:0,shouldRetryFn:t=>t.status===429});function Ee(e,t=Z,a){const r=async(s,o)=>{const{skipErrorHandler:c,...n}=o||{},i=await Ue(()=>fetch(t+(s!=null&&s.startsWith("/")?s:`/${s}`),{...n,headers:{...n.headers,Authorization:Re(e),"Content-Type":"application/json"}}));if(!i.ok){let d=await i.text().catch(()=>`Failed to fetch with status ${i.status}`);const l=new Error(d);throw a&&!c&&a(l,{url:s,options:n,headers:i.headers}),l}return i.json()};return{get(s,o){return r(s,{...o,method:"GET"})},post(s,o,c){return r(s,{...c,body:JSON.stringify(o),method:"POST"})},delete(s,o,c){return r(s,{...c,body:JSON.stringify(o),method:"DELETE"})},patch(s,o,c){return r(s,{...c,body:JSON.stringify(o),method:"PATCH"})}}}function Ie(e,t=Z,a){const r=Ee(e,`${t}/agents`,a);return{create(s,o){return r.post("/",s,o)},getAgents(s,o){return r.get(`/${s?`?tag=${s}`:""}`,o).then(c=>c??[])},getById(s,o){return r.get(`/${s}`,o)},delete(s,o){return r.delete(`/${s}`,void 0,o)},update(s,o,c){return r.patch(`/${s}`,o,c)},newChat(s,o,c){return r.post(`/${s}/chat`,o,c)},chat(s,o,c,n){return r.post(`/${s}/chat/${o}`,c,n)},createRating(s,o,c,n){return r.post(`/${s}/chat/${o}/ratings`,c,n)},updateRating(s,o,c,n,i){return r.patch(`/${s}/chat/${o}/ratings/${c}`,n,i)},deleteRating(s,o,c,n){return r.delete(`/${s}/chat/${o}/ratings/${c}`,n)},getSTTToken(s,o){return r.get(`/${s}/stt-token`,o)}}}const Me=e=>e.type==="clip"&&e.presenter_id.startsWith("v2_")?"clip_v2":e.type;function Ke(e){var s,o,c,n;const t=()=>/Mobi|Android/i.test(navigator.userAgent)?"Mobile":"Desktop",a=()=>{const i=navigator.platform;return i.toLowerCase().includes("win")?"Windows":i.toLowerCase().includes("mac")?"Mac OS X":i.toLowerCase().includes("linux")?"Linux":"Unknown"},r=e.presenter;return{$os:`${a()}`,isMobile:`${t()=="Mobile"}`,browser:navigator.userAgent,origin:window.location.origin,agentType:Me(r),agentVoice:{voiceId:(o=(s=e.presenter)==null?void 0:s.voice)==null?void 0:o.voice_id,provider:(n=(c=e.presenter)==null?void 0:c.voice)==null?void 0:n.type}}}function xe(e){var a,r,s,o,c,n;const t=(a=e.llm)==null?void 0:a.prompt_customization;return{agentType:Me(e.presenter),owner_id:e.owner_id??"",promptVersion:(r=e.llm)==null?void 0:r.prompt_version,behavior:{role:t==null?void 0:t.role,personality:t==null?void 0:t.personality,instructions:(s=e.llm)==null?void 0:s.instructions},temperature:(o=e.llm)==null?void 0:o.temperature,knowledgeSource:t==null?void 0:t.knowledge_source,starterQuestionsCount:(n=(c=e.knowledge)==null?void 0:c.starter_message)==null?void 0:n.length,topicsToAvoid:t==null?void 0:t.topics_to_avoid,maxResponseLength:t==null?void 0:t.max_response_length,agentId:e.id,access:e.access,name:e.preview_name,...e.access==="public"?{from:"agent-template"}:{}}}const He=e=>e.reduce((t,a)=>t+a,0),Te=e=>He(e)/e.length;function Ve(e,t,a){var i,d,l;const{event:r,...s}=e,{template:o}=(t==null?void 0:t.llm)||{},{language:c}=((i=t==null?void 0:t.presenter)==null?void 0:i.voice)||{};return{...s,llm:{...s.llm,template:o},script:{...s.script,provider:{...(d=s==null?void 0:s.script)==null?void 0:d.provider,language:c}},stitch:(t==null?void 0:t.presenter.type)==="talk"?(l=t==null?void 0:t.presenter)==null?void 0:l.stitch:void 0,...a}}let se={};const qe="https://api-js.mixpanel.com/track/?verbose=1&ip=1";function Oe(e){const t=window!=null&&window.hasOwnProperty("DID_AGENTS_API")?"agents-ui":"agents-sdk";return{token:e.token||"testKey",distinct_id:e.distinctId||Se(),agentId:e.agentId,additionalProperties:{id:e.distinctId,...e.mixpanelAdditionalProperties||{}},isEnabled:e.isEnabled??!0,getRandom:Q,enrich(a){this.additionalProperties={...this.additionalProperties,...a}},async track(a,r){if(!this.isEnabled)return Promise.resolve();const{audioPath:s,...o}=r||{},c={method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({data:JSON.stringify([{event:a,properties:{...this.additionalProperties,...o,agentId:this.agentId,source:t,token:this.token,time:Date.now(),$insert_id:this.getRandom(),origin:window.location.href,"Screen Height":window.screen.height||window.innerWidth,"Screen Width":window.screen.width||window.innerHeight,"User Agent":navigator.userAgent}}])})};try{return await fetch(qe,c).then(n=>n.json())}catch(n){return console.error(n)}},linkTrack(a,r,s,o){se[a]||(se[a]={events:{},resolvedDependencies:[]}),o.includes(s)||o.push(s);const c=se[a];if(c.events[s]={props:r},c.resolvedDependencies.push(s),o.every(i=>c.resolvedDependencies.includes(i))){const i=o.reduce((d,l)=>c.events[l]?{...d,...c.events[l].props}:d,{});this.track(a,i),c.resolvedDependencies=c.resolvedDependencies.filter(d=>!o.includes(d)),o.forEach(d=>{delete c.events[d]})}}}}function _e(){let e=0;return{reset:()=>e=0,update:()=>e=Date.now(),get:(t=!1)=>t?Date.now()-e:e}}const $=_e(),oe=_e();function Ae(e){return e===R.Playground?{headers:{[$e]:"true"}}:{}}async function je(e,t,a,r,s=!1,o){try{return!o&&!De(r)&&(o=await t.newChat(e.id,{persist:s},Ae(r)),a.track("agent-chat",{event:"created",chatId:o.id,mode:r})),{chat:o,chatMode:(o==null?void 0:o.chat_mode)??r}}catch(c){try{const n=JSON.parse(c.message);if((n==null?void 0:n.kind)==="InsufficientCreditsError")throw new Error("InsufficientCreditsError")}catch(n){console.error("Error parsing the error message:",n)}throw new Error("Cannot create new chat")}}function Xe(e){return e&&e.length>0?e:[]}function Ye(e,t,a){if(!e)throw new Error("Please connect to the agent first");if(!e.interruptAvailable)throw new Error("Interrupt is not enabled for this stream");if(t!==N.Fluent)throw new Error("Interrupt only available for Fluent streams");if(!a)throw new Error("No active video to interrupt")}async function Qe(e,t){const a={type:b.StreamInterrupt,videoId:t,timestamp:Date.now()};e.sendDataChannelMessage(JSON.stringify(a))}function Ge(e){return new Promise((t,a)=>{const{callbacks:r,host:s,auth:o}=e,{onMessage:c=null,onOpen:n=null,onClose:i=null,onError:d=null}=r||{},l=new WebSocket(`${s}?authorization=${Re(o)}`);l.onmessage=c,l.onclose=i,l.onerror=v=>{console.error(v),d==null||d("Websocket failed to connect",v),a(v)},l.onopen=v=>{n==null||n(v),t(l)}})}async function Ze(e){const{retries:t=1}=e;let a=null;for(let r=0;(a==null?void 0:a.readyState)!==WebSocket.OPEN;r++)try{a=await Ge(e)}catch(s){if(r===t)throw s;await Ce(r*500)}return a}async function et(e,t,a){const r=a!=null&&a.onMessage?[a.onMessage]:[],s=await Ze({auth:e,host:t,callbacks:{onError:o=>{var c;return(c=a.onError)==null?void 0:c.call(a,new le(o))},onMessage(o){const c=JSON.parse(o.data);r.forEach(n=>n(c.event,c))}}});return{socket:s,disconnect:()=>s.close(),subscribeToEvents:o=>r.push(o)}}function tt(e){if(e.answer!==void 0)return e.answer;let t=0,a="";for(;t in e;)a+=e[t++];return a}function rt(e,t,a,r,s){const o=r.messages[r.messages.length-1];if(!(e===q.Partial||e===q.Answer)||(o==null?void 0:o.role)!=="assistant")return;const{content:c,sequence:n}=t;e===q.Partial?a[n]=c:a.answer=c;const i=tt(a);(o.content!==i||e===q.Answer)&&(o.content=i,s==null||s([...r.messages],e))}function nt(e,t,a,r,s){let o={};return{clearQueue:()=>o={},onMessage:(c,n)=>{var i,d;if("content"in n)rt(c,n,o,t,a.callbacks.onNewMessage),c===q.Answer&&e.track("agent-message-received",{messages:t.messages.length,mode:t.chatMode});else{const l=b,v=[l.StreamVideoDone,l.StreamVideoError,l.StreamVideoRejected],_=[l.StreamFailed,l.StreamVideoError,l.StreamVideoRejected],P=Ve(n,r,{mode:t.chatMode});if(c=c,c===l.StreamVideoCreated)e.linkTrack("agent-video",P,l.StreamVideoCreated,["start"]);else if(v.includes(c)){const B=c.split("/")[1];_.includes(c)?e.track("agent-video",{...P,event:B}):e.linkTrack("agent-video",{...P,event:B},c,["done"])}_.includes(c)&&((d=(i=a.callbacks).onError)==null||d.call(i,new Error(`Stream failed with event ${c}`),{data:n})),n.event===l.StreamDone&&s()}}}}function at(e,t,a,r){const s=Ee(e,`${t}/agents/${a}`,r);return{createStream(o){return s.post("/streams",o)},startConnection(o,c,n){return s.post(`/streams/${o}/sdp`,{session_id:n,answer:c})},addIceCandidate(o,c,n){return s.post(`/streams/${o}/ice`,{session_id:n,...c})},sendStreamRequest(o,c,n){return s.post(`/streams/${o}`,{session_id:c,...n})},close(o,c){return s.delete(`/streams/${o}`,{session_id:c})}}}const it=(e,t)=>(a,r)=>e&&console.log(`[${t}] ${a}`,r??"");function st(e,t,a){const r=(t.timestamp-e.timestamp)/1e3;return{duration:r,bytesReceived:t.bytesReceived-e.bytesReceived,bitrate:Math.round((t.bytesReceived-e.bytesReceived)*8/r),packetsReceived:t.packetsReceived-e.packetsReceived,packetsLost:t.packetsLost-e.packetsLost,framesDropped:t.framesDropped-e.framesDropped,framesDecoded:t.framesDecoded-e.framesDecoded,jitter:t.jitter,avgJitterDelayInInterval:(t.jitterBufferDelay-e.jitterBufferDelay)/(t.jitterBufferEmittedCount-e.jitterBufferEmittedCount),jitterBufferEmittedCount:t.jitterBufferEmittedCount-e.jitterBufferEmittedCount,jitterBufferDelay:(t.jitterBufferDelay-e.jitterBufferDelay)/r,framesPerSecond:t.framesPerSecond,freezeCount:t.freezeCount-e.freezeCount,freezeDuration:t.freezeDuration-e.freezeDuration,lowFpsCount:a}}function ot(e){return e.filter(t=>t.freezeCount>0||t.framesPerSecond<21||t.framesDropped>0||t.packetsLost>0).map(t=>{const{timestamp:a,...r}=t,s=[];return t.freezeCount>0&&s.push("freeze"),t.framesPerSecond<21&&s.push("low fps"),t.framesDropped>0&&s.push("frames dropped"),t.packetsLost>0&&s.push("packet loss"),{...r,causes:s}})}function ct(e){let t="",a=0;for(const r of e.values())if(r&&r.type==="codec"&&r.mimeType.startsWith("video")&&(t=r.mimeType.split("/")[1]),r&&r.type==="candidate-pair"&&(a=r.currentRoundTripTime),r&&r.type==="inbound-rtp"&&r.kind==="video")return{codec:t,rtt:a,timestamp:r.timestamp,bytesReceived:r.bytesReceived,packetsReceived:r.packetsReceived,packetsLost:r.packetsLost,framesDropped:r.framesDropped,framesDecoded:r.framesDecoded,jitter:r.jitter,jitterBufferDelay:r.jitterBufferDelay,jitterBufferEmittedCount:r.jitterBufferEmittedCount,avgJitterDelayInInterval:r.jitterBufferDelay/r.jitterBufferEmittedCount,frameWidth:r.frameWidth,frameHeight:r.frameHeight,framesPerSecond:r.framesPerSecond,freezeCount:r.freezeCount,freezeDuration:r.totalFreezesDuration};return{}}function dt(e,t,a){const r=e.map((i,d)=>d===0?a?{timestamp:i.timestamp,duration:0,rtt:i.rtt,bytesReceived:i.bytesReceived-a.bytesReceived,bitrate:(i.bytesReceived-a.bytesReceived)*8/(t/1e3),packetsReceived:i.packetsReceived-a.packetsReceived,packetsLost:i.packetsLost-a.packetsLost,framesDropped:i.framesDropped-a.framesDropped,framesDecoded:i.framesDecoded-a.framesDecoded,jitter:i.jitter,jitterBufferDelay:i.jitterBufferDelay-a.jitterBufferDelay,jitterBufferEmittedCount:i.jitterBufferEmittedCount-a.jitterBufferEmittedCount,avgJitterDelayInInterval:(i.jitterBufferDelay-a.jitterBufferDelay)/(i.jitterBufferEmittedCount-a.jitterBufferEmittedCount),framesPerSecond:i.framesPerSecond,freezeCount:i.freezeCount-a.freezeCount,freezeDuration:i.freezeDuration-a.freezeDuration}:{timestamp:i.timestamp,rtt:i.rtt,duration:0,bytesReceived:i.bytesReceived,bitrate:i.bytesReceived*8/(t/1e3),packetsReceived:i.packetsReceived,packetsLost:i.packetsLost,framesDropped:i.framesDropped,framesDecoded:i.framesDecoded,jitter:i.jitter,jitterBufferDelay:i.jitterBufferDelay,jitterBufferEmittedCount:i.jitterBufferEmittedCount,avgJitterDelayInInterval:i.jitterBufferDelay/i.jitterBufferEmittedCount,framesPerSecond:i.framesPerSecond,freezeCount:i.freezeCount,freezeDuration:i.freezeDuration}:{timestamp:i.timestamp,duration:t*d/1e3,rtt:i.rtt,bytesReceived:i.bytesReceived-e[d-1].bytesReceived,bitrate:(i.bytesReceived-e[d-1].bytesReceived)*8/(t/1e3),packetsReceived:i.packetsReceived-e[d-1].packetsReceived,packetsLost:i.packetsLost-e[d-1].packetsLost,framesDropped:i.framesDropped-e[d-1].framesDropped,framesDecoded:i.framesDecoded-e[d-1].framesDecoded,jitter:i.jitter,jitterBufferDelay:i.jitterBufferDelay-e[d-1].jitterBufferDelay,jitterBufferEmittedCount:i.jitterBufferEmittedCount-e[d-1].jitterBufferEmittedCount,avgJitterDelayInInterval:(i.jitterBufferDelay-e[d-1].jitterBufferDelay)/(i.jitterBufferEmittedCount-e[d-1].jitterBufferEmittedCount),framesPerSecond:i.framesPerSecond,freezeCount:i.freezeCount-e[d-1].freezeCount,freezeDuration:i.freezeDuration-e[d-1].freezeDuration}),s=ot(r),o=s.reduce((i,d)=>i+(d.causes.includes("low fps")?1:0),0),c=r.filter(i=>!!i.avgJitterDelayInInterval).map(i=>i.avgJitterDelayInInterval),n=r.filter(i=>!!i.rtt).map(i=>i.rtt);return{webRTCStats:{anomalies:s,minRtt:Math.min(...n),avgRtt:Te(n),maxRtt:Math.max(...n),aggregateReport:st(e[0],e[e.length-1],o),minJitterDelayInInterval:Math.min(...c),maxJitterDelayInInterval:Math.max(...c),avgJitterDelayInInterval:Te(c)},codec:e[0].codec,resolution:`${e[0].frameWidth}x${e[0].frameHeight}`}}const ce=100,lt=Math.max(Math.ceil(400/ce),1),ut=.25,ft=.28;function mt(){let e=0,t,a,r=0;return s=>{for(const o of s.values())if(o&&o.type==="inbound-rtp"&&o.kind==="video"){const c=o.jitterBufferDelay,n=o.jitterBufferEmittedCount;if(a&&n>a){const l=c-t,v=n-a;r=l/v}t=c,a=n;const i=o.framesDecoded,d=i-e>0;return e=i,{isReceiving:d,avgJitterDelayInInterval:r,freezeCount:o.freezeCount}}return{isReceiving:!1,avgJitterDelayInInterval:r}}}function gt(e,t,a,r,s,o=!1){let c=[],n,i=0,d=!1,l=Y.Unknown,v=Y.Unknown,_=0,P=0;const B=mt();return setInterval(async()=>{const W=await e.getStats(),{isReceiving:X,avgJitterDelayInInterval:x,freezeCount:E}=B(W),G=ct(W);if(X)i=0,_=E-P,v=x<ut?Y.Strong:x>ft&&_>1?Y.Weak:l,v!==l&&(s==null||s(v),l=v,P+=_,_=0),d||(r==null||r(w.Start),n=c[c.length-1],c=[],d=!0),c.push(G);else if(d&&(i++,i>=lt)){const u=dt(c,ce,n);r==null||r(w.Stop,u),t()||a(),P=E,d=!1}},ce)}const ht=(window.RTCPeerConnection||window.webkitRTCPeerConnection||window.mozRTCPeerConnection).bind(window);function be(e){switch(e){case"connected":return D.Connected;case"checking":return D.Connecting;case"failed":return D.Fail;case"new":return D.New;case"closed":return D.Closed;case"disconnected":return D.Disconnected;case"completed":return D.Completed;default:return D.New}}const wt=e=>t=>{const[a,r=""]=t.split(/:(.+)/);try{const s=JSON.parse(r);return e("parsed data channel message",{subject:a,data:s}),{subject:a,data:s}}catch(s){return e("Failed to parse data channel message, returning data as string",{subject:a,rawData:r,error:s}),{subject:a,data:r}}};function pt({statsSignal:e,dataChannelSignal:t,onVideoStateChange:a,report:r}){e===w.Start&&t===w.Start?a==null||a(w.Start):e===w.Stop&&t===w.Stop&&(a==null||a(w.Stop,r))}function yt({statsSignal:e,dataChannelSignal:t,onVideoStateChange:a,onAgentActivityStateChange:r,report:s}){e===w.Start?a==null||a(w.Start):e===w.Stop&&(a==null||a(w.Stop,s)),t===w.Start?r==null||r(O.Talking):t===w.Stop&&(r==null||r(O.Idle))}function Pe({statsSignal:e,dataChannelSignal:t,onVideoStateChange:a,onAgentActivityStateChange:r,streamType:s,report:o}){s===N.Legacy?pt({statsSignal:e,dataChannelSignal:t,onVideoStateChange:a,report:o}):s===N.Fluent&&yt({statsSignal:e,dataChannelSignal:t,onVideoStateChange:a,onAgentActivityStateChange:r,report:o})}async function vt(e,t,{debug:a=!1,callbacks:r,auth:s,baseURL:o=Z,analytics:c}){var te;const n=it(a,"WebRTCStreamingManager"),i=wt(n);let d=!1,l=!1,v=w.Stop,_=w.Stop;const{startConnection:P,sendStreamRequest:B,close:W,createStream:X,addIceCandidate:x}=at(s,o,e,r.onError),{id:E,offer:G,ice_servers:u,session_id:p,fluent:y,interrupt_enabled:A,triggers_enabled:k}=await X(t);(te=r.onStreamCreated)==null||te.call(r,{stream_id:E,session_id:p,agent_id:e});const m=new ht({iceServers:u}),M=m.createDataChannel("JanusDataChannel");if(!p)throw new Error("Could not create session_id");const j=y?N.Fluent:N.Legacy;c.enrich({"stream-type":j});const z=t.stream_warmup&&!y,S=()=>d,T=()=>{var g;d=!0,l&&((g=r.onConnectionStateChange)==null||g.call(r,D.Connected))},C=gt(m,S,T,(g,h)=>Pe({statsSignal:_=g,dataChannelSignal:j===N.Legacy?v:void 0,onVideoStateChange:r.onVideoStateChange,onAgentActivityStateChange:r.onAgentActivityStateChange,report:h,streamType:j}),g=>{var h;return(h=r.onConnectivityStateChange)==null?void 0:h.call(r,g)},z);m.onicecandidate=g=>{var h;n("peerConnection.onicecandidate",g);try{g.candidate&&g.candidate.sdpMid&&g.candidate.sdpMLineIndex!==null?x(E,{candidate:g.candidate.candidate,sdpMid:g.candidate.sdpMid,sdpMLineIndex:g.candidate.sdpMLineIndex},p):x(E,{candidate:null},p)}catch(L){(h=r.onError)==null||h.call(r,L,{streamId:E})}},M.onopen=()=>{l=!0,(!z||d)&&T()};const J=g=>{var h;(h=r.onVideoIdChange)==null||h.call(r,g)};function F(g,h){if(g===b.StreamStarted&&typeof h=="object"&&"metadata"in h){const L=h.metadata;J(L.videoId)}g===b.StreamDone&&J(null),v=g===b.StreamStarted?w.Start:w.Stop,Pe({statsSignal:j===N.Legacy?_:void 0,dataChannelSignal:v,onVideoStateChange:r.onVideoStateChange,onAgentActivityStateChange:r.onAgentActivityStateChange,streamType:j})}function U(g,h){const L=typeof h=="string"?h:h==null?void 0:h.metadata;L&&c.enrich({streamMetadata:L}),c.track("agent-chat",{event:"ready"})}const K={[b.StreamStarted]:F,[b.StreamDone]:F,[b.StreamReady]:U};M.onmessage=g=>{var re;const{subject:h,data:L}=i(g.data);(re=K[h])==null||re.call(K,h,L)},m.oniceconnectionstatechange=()=>{var h;n("peerConnection.oniceconnectionstatechange => "+m.iceConnectionState);const g=be(m.iceConnectionState);g!==D.Connected&&((h=r.onConnectionStateChange)==null||h.call(r,g))},m.ontrack=g=>{var h;n("peerConnection.ontrack",g),(h=r.onSrcObjectReady)==null||h.call(r,g.streams[0])},await m.setRemoteDescription(G),n("set remote description OK");const ee=await m.createAnswer();return n("create answer OK"),await m.setLocalDescription(ee),n("set local description OK"),await P(E,ee,p),n("start connection OK"),{speak(g){return B(E,p,g)},async disconnect(){var g;if(E){const h=be(m.iceConnectionState);if(m){if(h===D.New){clearInterval(C);return}m.close(),m.oniceconnectionstatechange=null,m.onnegotiationneeded=null,m.onicecandidate=null,m.ontrack=null}try{h===D.Connected&&await W(E,p).catch(L=>{})}catch(L){n("Error on close stream connection",L)}(g=r.onAgentActivityStateChange)==null||g.call(r,O.Idle),clearInterval(C)}},sendDataChannelMessage(g){var h,L;if(!d||M.readyState!=="open"){n("Data channel is not ready for sending messages"),(h=r.onError)==null||h.call(r,new Error("Data channel is not ready for sending messages"),{streamId:E});return}try{M.send(g)}catch(re){n("Error sending data channel message",re),(L=r.onError)==null||L.call(r,re,{streamId:E})}},sessionId:p,streamId:E,streamType:j,interruptAvailable:A??!1,triggersAvailable:k??!1}}const kt=e=>e.presenter.type===ae.Expressive;async function Ct(e,t,a){const r=e.id;return kt(e)?{}:vt(r,t,a)}function Dt(e){const{streamOptions:t}=e??{};return{output_resolution:t==null?void 0:t.outputResolution,session_timeout:t==null?void 0:t.sessionTimeout,stream_warmup:t==null?void 0:t.streamWarmup,compatibility_mode:t==null?void 0:t.compatibilityMode,fluent:t==null?void 0:t.fluent}}function St(e,t,a,r,s){s===N.Fluent?Rt(e,t,a,r,s):It(e,t,a,r,s)}function Rt(e,t,a,r,s){e===w.Start?r.track("stream-session",{event:"start","stream-type":s}):e===w.Stop&&r.track("stream-session",{event:"stop",is_greenscreen:t.presenter.type==="clip"&&t.presenter.is_greenscreen,background:t.presenter.type==="clip"&&t.presenter.background,"stream-type":s,...a})}function Et(e,t,a,r){$.get()<=0||(e===w.Start?a.linkTrack("agent-video",{event:"start",latency:$.get(!0),"stream-type":r},"start",[b.StreamVideoCreated]):e===w.Stop&&a.linkTrack("agent-video",{event:"stop",is_greenscreen:t.presenter.type==="clip"&&t.presenter.is_greenscreen,background:t.presenter.type==="clip"&&t.presenter.background,"stream-type":r},"done",[b.StreamVideoDone]))}function It(e,t,a,r,s){$.get()<=0||(e===w.Start?r.linkTrack("agent-video",{event:"start",latency:$.get(!0),"stream-type":s},"start",[b.StreamVideoCreated]):e===w.Stop&&r.linkTrack("agent-video",{event:"stop",is_greenscreen:t.presenter.type==="clip"&&t.presenter.is_greenscreen,background:t.presenter.type==="clip"&&t.presenter.background,"stream-type":s,...a},"done",[b.StreamVideoDone]))}function Mt(e,t,a){return $.reset(),new Promise(async(r,s)=>{try{let o;o=await Ct(e,Dt(t),{...t,analytics:a,callbacks:{...t.callbacks,onConnectionStateChange:c=>{var n,i;(i=(n=t.callbacks).onConnectionStateChange)==null||i.call(n,c),c===D.Connected&&r(o)},onVideoStateChange:(c,n)=>{var i,d;(d=(i=t.callbacks).onVideoStateChange)==null||d.call(i,c),St(c,e,n,a,o.streamType)},onAgentActivityStateChange:c=>{var n,i;(i=(n=t.callbacks).onAgentActivityStateChange)==null||i.call(n,c),c===O.Talking?oe.update():oe.reset(),Et(c===O.Talking?w.Start:w.Stop,e,a,o.streamType)}}})}catch(o){s(o)}})}async function Tt(e,t,a,r,s){var v,_,P,B;const o=je(e,a,r,t.mode,t.persistentChat,s),c=Mt(e,t,r),[n,i]=await Promise.all([o,c]),{chat:d,chatMode:l}=n;return l&&l!==t.mode&&(t.mode=l,(_=(v=t.callbacks).onModeChange)==null||_.call(v,l),l!==R.Functional)?((B=(P=t.callbacks).onError)==null||B.call(P,new de(l)),i==null||i.disconnect(),{chat:d}):{chat:d,streamingManager:i}}async function _t(e,t){var x,E,G;let a=!0,r=null;const s=t.mixpanelKey||Fe,o=t.wsURL||ze,c=t.baseURL||Z,n={messages:[],chatMode:t.mode||R.Functional},i=Oe({token:s,agentId:e,isEnabled:t.enableAnalitics,distinctId:t.distinctId,mixpanelAdditionalProperties:t.mixpanelAdditionalProperties});i.track("agent-sdk",{event:"init"});const d=Ie(t.auth,c,t.callbacks.onError),l=await d.getById(e);i.enrich(xe(l));const{onMessage:v,clearQueue:_}=nt(i,n,t,l,()=>{var u;return(u=n.socketManager)==null?void 0:u.disconnect()});n.messages=Xe(t.initialMessages),(E=(x=t.callbacks).onNewMessage)==null||E.call(x,[...n.messages],"answer");const P=u=>{r=u};i.track("agent-sdk",{event:"loaded",...Ke(l)});async function B(u){var M,j,z,S,T,C,J;(j=(M=t.callbacks).onConnectionStateChange)==null||j.call(M,D.Connecting),$.reset(),u&&!a&&(delete n.chat,(S=(z=t.callbacks).onNewMessage)==null||S.call(z,[...n.messages],"answer"));const p=t.mode===R.DirectPlayback?Promise.resolve(void 0):et(t.auth,o,{onMessage:v,onError:t.callbacks.onError}),y=ie(()=>Tt(l,{...t,callbacks:{...t.callbacks,onVideoIdChange:P}},d,i,n.chat),{limit:3,timeout:Be,timeoutErrorMessage:"Timeout initializing the stream",shouldRetryFn:F=>(F==null?void 0:F.message)!=="Could not connect"&&F.status!==429,delayMs:1e3}).catch(F=>{var U,K;throw X(R.Maintenance),(K=(U=t.callbacks).onConnectionStateChange)==null||K.call(U,D.Fail),F}),[A,{streamingManager:k,chat:m}]=await Promise.all([p,y]);m&&m.id!==((T=n.chat)==null?void 0:T.id)&&((J=(C=t.callbacks).onNewChat)==null||J.call(C,m.id)),n.streamingManager=k,n.socketManager=A,n.chat=m,a=!1,i.enrich({chatId:m==null?void 0:m.id,streamId:k==null?void 0:k.streamId,mode:n.chatMode}),X((m==null?void 0:m.chat_mode)??t.mode??R.Functional)}async function W(){var u,p,y,A;(u=n.socketManager)==null||u.disconnect(),await((p=n.streamingManager)==null?void 0:p.disconnect()),delete n.streamingManager,delete n.socketManager,(A=(y=t.callbacks).onConnectionStateChange)==null||A.call(y,D.Disconnected)}async function X(u){var p,y;u!==n.chatMode&&(i.track("agent-mode-change",{mode:u}),n.chatMode=u,n.chatMode!==R.Functional&&await W(),(y=(p=t.callbacks).onModeChange)==null||y.call(p,u))}return{agent:l,getStreamType:()=>{var u;return(u=n.streamingManager)==null?void 0:u.streamType},getIsInterruptAvailable:()=>{var u;return((u=n.streamingManager)==null?void 0:u.interruptAvailable)??!1},getIsTriggersAvailable:()=>{var u;return((u=n.streamingManager)==null?void 0:u.triggersAvailable)??!1},starterMessages:((G=l.knowledge)==null?void 0:G.starter_message)||[],getSTTToken:()=>d.getSTTToken(l.id),changeMode:X,enrichAnalytics:i.enrich,async connect(){await B(!0),i.track("agent-chat",{event:"connect",mode:n.chatMode})},async reconnect(){await W(),await B(!1),i.track("agent-chat",{event:"reconnect",mode:n.chatMode})},async disconnect(){await W(),i.track("agent-chat",{event:"disconnect",mode:n.chatMode})},async chat(u){var k,m,M,j,z;const p=()=>{if(De(t.mode))throw new V(`${t.mode} is enabled, chat is disabled`);if(u.length>=800)throw new V("Message cannot be more than 800 characters");if(u.length===0)throw new V("Message cannot be empty");if(n.chatMode===R.Maintenance)throw new V("Chat is in maintenance mode");if(![R.TextOnly,R.Playground].includes(n.chatMode)){if(!n.streamingManager)throw new V("Streaming manager is not initialized");if(!n.chat)throw new V("Chat is not initialized")}},y=async()=>{var S,T;if(!n.chat){const C=await je(l,d,i,n.chatMode,t.persistentChat);if(!C.chat)throw new H(n.chatMode,!!t.persistentChat);n.chat=C.chat,(T=(S=t.callbacks).onNewChat)==null||T.call(S,n.chat.id)}return n.chat.id},A=async(S,T)=>ie(()=>{var C,J;return d.chat(l.id,T,{chatMode:n.chatMode,streamId:(C=n.streamingManager)==null?void 0:C.streamId,sessionId:(J=n.streamingManager)==null?void 0:J.sessionId,messages:S.map(({matches:F,...U})=>U)},{...Ae(n.chatMode),skipErrorHandler:!0})},{limit:2,shouldRetryFn:C=>{var U,K,ee,te;const J=(U=C==null?void 0:C.message)==null?void 0:U.includes("missing or invalid session_id");return!((K=C==null?void 0:C.message)==null?void 0:K.includes("Stream Error"))&&!J?((te=(ee=t.callbacks).onError)==null||te.call(ee,C),!1):!0},onRetry:async()=>{await W(),await B(!1)}});try{_(),p(),n.messages.push({id:Q(),role:"user",content:u,created_at:new Date($.update()).toISOString()}),(m=(k=t.callbacks).onNewMessage)==null||m.call(k,[...n.messages],"user");const S=await y(),T=await A([...n.messages],S);return n.messages.push({id:Q(),role:"assistant",content:T.result||"",created_at:new Date().toISOString(),context:T.context,matches:T.matches}),i.track("agent-message-send",{event:"success",messages:n.messages.length+1}),T.result&&((j=(M=t.callbacks).onNewMessage)==null||j.call(M,[...n.messages],"answer"),i.track("agent-message-received",{latency:$.get(!0),messages:n.messages.length})),T}catch(S){throw((z=n.messages[n.messages.length-1])==null?void 0:z.role)==="assistant"&&n.messages.pop(),i.track("agent-message-send",{event:"error",messages:n.messages.length}),S}},rate(u,p,y){var m,M,j,z;const A=n.messages.find(S=>S.id===u);if(n.chat){if(!A)throw new Error("Message not found")}else throw new Error("Chat is not initialized");const k=((m=A.matches)==null?void 0:m.map(S=>[S.document_id,S.id]))??[];return i.track("agent-rate",{event:y?"update":"create",thumb:p===1?"up":"down",knowledge_id:((M=l.knowledge)==null?void 0:M.id)??"",matches:k,score:p}),y?d.updateRating(l.id,n.chat.id,y,{knowledge_id:((j=l.knowledge)==null?void 0:j.id)??"",message_id:u,matches:k,score:p}):d.createRating(l.id,n.chat.id,{knowledge_id:((z=l.knowledge)==null?void 0:z.id)??"",message_id:u,matches:k,score:p})},deleteRate(u){if(!n.chat)throw new Error("Chat is not initialized");return i.track("agent-rate-delete",{type:"text"}),d.deleteRating(l.id,n.chat.id,u)},async speak(u){var k,m,M;function p(){if(typeof u=="string"){if(!l.presenter.voice)throw new Error("Presenter voice is not initialized");return{type:"text",provider:l.presenter.voice,input:u,ssml:!1}}if(u.type==="text"&&!u.provider){if(!l.presenter.voice)throw new Error("Presenter voice is not initialized");return{type:"text",provider:l.presenter.voice,input:u.input,ssml:u.ssml}}return u}const y=p();if(i.track("agent-speak",y),$.update(),n.messages&&y.type==="text"&&(n.messages.push({id:Q(),role:"assistant",content:y.input,created_at:new Date($.get(!0)).toISOString()}),(m=(k=t.callbacks).onNewMessage)==null||m.call(k,[...n.messages],"answer")),Ne(n.chatMode))return{duration:0,video_id:"",status:"success"};if(!n.streamingManager)throw new Error("Please connect to the agent first");return n.streamingManager.speak({script:y,metadata:{chat_id:(M=n.chat)==null?void 0:M.id,agent_id:l.id}})},async interrupt({type:u}){var y,A,k;Ye(n.streamingManager,(y=n.streamingManager)==null?void 0:y.streamType,r);const p=n.messages[n.messages.length-1];i.track("agent-video-interrupt",{type:u||"click",video_duration_to_interrupt:oe.get(!0),message_duration_to_interrupt:$.get(!0)}),p.interrupted=!0,(k=(A=t.callbacks).onNewMessage)==null||k.call(A,[...n.messages],"answer"),Qe(n.streamingManager,r)}}}function At(e,t,a){const{getById:r}=Ie(t,a||Z);return r(e)}f.AgentActivityState=O,f.AgentStatus=me,f.ChatCreationFailed=H,f.ChatMode=R,f.ChatModeDowngraded=de,f.ChatProgress=q,f.ConnectionState=D,f.ConnectivityState=Y,f.DocumentType=pe,f.KnowledgeType=we,f.PlanGroup=fe,f.Providers=ve,f.RateState=ge,f.StreamEvents=b,f.StreamType=N,f.StreamingState=w,f.Subject=he,f.Transport=ye,f.UserPlan=ue,f.ValidationError=V,f.VideoType=ae,f.VoiceAccess=ke,f.WsError=le,f.createAgentManager=_t,f.getAgent=At,f.mapVideoType=Le,Object.defineProperty(f,Symbol.toStringTag,{value:"Module"})});
